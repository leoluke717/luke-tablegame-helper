# 桌游助手 - 游戏设置功能产品需求文档 (PRD)

**文档版本：** v1.0
**创建日期：** 2025-11-12
**项目名称：** 桌游助手
**功能模块：** 游戏设置与管理
**产品经理：** [待填写]
**技术负责人：** [待填写]

---

## 1. 项目概述 (Project Overview)

### 1.1 项目背景
桌游助手项目旨在为多人桌游提供实时协作功能。当前项目已实现基础的房间管理、玩家系统（头像、昵称）等功能。现需要增加游戏设置功能，使管理员能够配置和管理不同游戏的参数，提升游戏的灵活性和可扩展性。

### 1.2 项目目标
- 实现管理员对游戏参数的统一配置管理
- 为后续支持多款桌游建立扩展架构
- 提升管理员对游戏流程的控制能力
- 为玩家提供差异化的游戏体验

### 1.3 目标用户
- **管理员（房主）**：具有房间管理权限，负责游戏配置和流程控制
- **普通玩家**：参与游戏体验，无法访问管理功能

---

## 2. 功能需求详述 (Functional Requirements)

### 2.1 大厅界面权限控制
**功能描述：** 实现基于管理员身份的大厅界面访问控制机制

**详细需求：**
- **访问控制**
  - 大厅界面（`/lobby/:roomId`）仅对管理员可见
  - 普通用户尝试访问时重定向至首页（`/`）
  - 已登录用户根据权限动态显示界面元素

- **权限判断逻辑**
  - 基于现有 `isHost` 字段判断管理员身份
  - 通过比较 `currentPlayerId.value === hostId.value` 确定权限
  - 与现有房主权限管理系统保持一致

**业务价值：**
- 确保管理功能的安全性和可控性
- 防止普通用户误操作影响游戏设置

---

### 2.2 游戏选择功能
**功能描述：** 在大厅界面提供游戏类型选择下拉菜单

**详细需求：**
- **界面元素**
  - 位置：大厅界面顶部，房间信息下方
  - 组件：下拉选择框（`<select>` 或 Vue 自定义组件）
  - 标签：显示"🎯 选择游戏"

- **选项配置**
  - 默认选项：「屁者先知」
  - 扩展选项：为后续游戏预留选项位
  - 数据结构支持动态加载

- **数据存储**
  - 存储位置：`rooms/{roomId}/selectedGame`
  - 持久化：选择结果实时同步至 Firebase
  - 默认值：首次进入大厅时自动设置为「屁者先知」

- **交互行为**
  - 选择后立即保存至数据库
  - 所有房间成员可实时看到选择结果
  - 管理员可随时修改选择

**业务价值：**
- 为支持多款游戏奠定基础
- 提升游戏启动前的配置灵活性

---

### 2.3 开始菜单游戏设置按钮
**功能描述：** 在大厅界面增加管理员专用的游戏设置入口

**详细需求：**
- **按钮设计**
  - 位置：「开始游戏」按钮左侧
  - 样式：次要按钮样式（灰色边框，白色背景）
  - 文案：「⚙️ 游戏设置」
  - 图标：使用齿轮 emoji 增强识别度

- **权限控制**
  - **仅管理员可见**：通过 `v-if="isHost"` 指令控制
  - **普通用户不可见**：非房主用户界面中不渲染该按钮
  - 防止权限越界：前端隐藏 + 后端权限校验

- **交互行为**
  - 点击后跳转至：`/game-settings/:roomId`
  - 使用 Vue Router 编程式导航：`router.push(/game-settings/${roomId})`
  - 跳转前保存当前选择的游戏类型

- **移动端适配**
  - 按钮尺寸适配小屏幕
  - 保持与其他按钮的一致性
  - 触摸区域不小于 44px × 44px

**业务价值：**
- 为管理员提供便捷的游戏配置入口
- 清晰的功能分区，避免误操作

---

### 2.4 游戏参数设置界面
**功能描述：** 创建独立的游戏设置页面，支持不同游戏类型的参数配置

**详细需求：**
- **页面路由**
  - 路径：`/game-settings/:roomId`
  - 组件名：`GameSettingsView.vue`
  - 需在 `src/router/index.js` 中新增路由配置

- **界面布局**
  - 顶部：页面标题 + 返回大厅按钮
  - 主体：动态渲染游戏设置表单
  - 底部：保存 / 取消按钮

- **游戏设置组件架构**
  ```
  GameSettingsView.vue (父组件)
  ├── GameSelector (游戏选择器)
  ├── GameConfig (游戏配置容器)
  │   ├── PiZheXianZhiConfig (屁者先知配置组件)
  │   ├── FutureGameConfig (未来游戏配置组件)
  │   └── ...
  └── ActionButtons (保存/取消)
  ```

- **数据流设计**
  - **读取**：从 `rooms/{roomId}/gameSettings` 读取配置
  - **写入**：更新时保存至相同路径
  - **实时同步**：所有成员可看到配置变更
  - **版本控制**：记录配置更新时间戳

- **参数配置框架**
  - 每个游戏定义独立的配置 schema
  - 使用 Vue 动态组件 `<component :is="currentGameComponent">` 渲染
  - 支持多种输入类型：文本、数字、布尔、选择、范围滑块
  - 参数校验：实时验证输入合法性

- **屁者先知游戏参数示例**
  - 基础参数：回合时间限制（30s/60s/90s/无限制）
  - 胜利条件：得分目标（100分/150分/200分/自定义）
  - 特殊规则：是否启用「惩罚卡」
  - 玩家数量：支持人数（3-8人）
  - 难度等级：简单/中等/困难

**业务价值：**
- 高度可配置的游戏体验
- 支持不同游戏规则的灵活适配
- 为未来新游戏提供标准化配置入口

---

## 3. 用户故事 (User Stories)

### 3.1 管理员视角

**作为房主，我希望能够在大厅界面选择不同类型的游戏，以便：**
- 根据玩家数量和偏好选择合适的游戏
- 快速切换到不同的桌游类型
- 为下次游戏积累不同游戏的经验

**验收标准：**
- [ ] 大厅界面显示游戏选择下拉菜单
- [ ] 默认选中「屁者先知」
- [ ] 下拉菜单包含至少1个可选项
- [ ] 选择后立即保存并显示在界面

---

**作为房主，我希望能够通过按钮进入游戏设置页面，以便：**
- 在游戏开始前详细配置游戏参数
- 为本次游戏设置特殊规则
- 根据玩家情况调整游戏难度

**验收标准：**
- [ ] 大厅界面显示「游戏设置」按钮
- [ ] 按钮位置合理（开始游戏按钮左侧）
- [ ] 点击后跳转到游戏设置页面
- [ ] 仅房主可见，普通用户看不到该按钮

---

**作为房主，我希望能够配置游戏的各项参数，以便：**
- 调整游戏难度适应玩家水平
- 控制单局游戏时长
- 启用或禁用特定游戏规则
- 创建差异化的游戏体验

**验收标准：**
- [ ] 游戏设置页面正确显示当前选择的游戏
- [ ] 页面包含完整的参数配置表单
- [ ] 参数修改后可保存至数据库
- [ ] 保存后其他玩家能实时看到配置变更
- [ ] 支持参数重置为默认值

---

### 3.2 普通玩家视角

**作为玩家，我希望看到管理员选择的游戏类型，以便：**
- 了解即将进行的游戏内容
- 提前准备或调整心态
- 决定是否参与本局游戏

**验收标准：**
- [ ] 大厅界面显示当前选择的游戏名称
- [ ] 所有玩家（包括非管理员）都能看到选择结果
- [ ] 选择变更时界面实时更新

---

**作为玩家，我希望不受游戏设置功能的干扰，以便：**
- 界面简洁不复杂
- 专注于游戏社交和准备
- 避免误触管理功能

**验收标准：**
- [ ] 玩家界面不显示「游戏设置」按钮
- [ ] 玩家无法访问游戏设置页面（直接访问URL会重定向）
- [ ] 玩家界面保持简洁清晰

---

## 4. 验收标准 (Acceptance Criteria)

### 4.1 权限控制验收标准
- [ ] 普通用户直接访问 `/lobby/:roomId` 时显示错误或重定向
- [ ] 房主身份验证机制与现有系统一致
- [ ] 前端权限控制和后端权限校验双重保障
- [ ] 权限变更时界面立即响应（实时同步）

### 4.2 游戏选择验收标准
- [ ] 下拉菜单正确显示在指定位置
- [ ] 默认选项为「屁者先知」
- [ ] 选择后数据持久化至 `rooms/{roomId}/selectedGame`
- [ ] 刷新页面后保持选择结果
- [ ] 所有玩家实时看到选择变化

### 4.3 游戏设置按钮验收标准
- [ ] 按钮仅房主可见（`v-if="isHost"`）
- [ ] 点击后正确跳转至 `/game-settings/:roomId`
- [ ] 按钮样式与其他按钮保持一致
- [ ] 移动端按钮大小适中，触摸友好
- [ ] 按钮文本和图标清晰可识别

### 4.4 游戏设置页面验收标准
- [ ] 页面正确路由到 `/game-settings/:roomId`
- [ ] 页面标题显示当前房间号
- [ ] 显示当前选择的游戏类型
- [ ] 参数配置表单完整可用
- [ ] 参数保存后实时同步至数据库
- [ ] 支持取消操作返回大厅
- [ ] 参数修改后其他玩家能实时看到

### 4.5 扩展性验收标准
- [ ] 支持后续添加新游戏选项
- [ ] 新游戏可独立配置参数
- [ ] 配置组件可复用和扩展
- [ ] 游戏类型变更时界面动态切换

---

## 5. 技术集成方案 (Technical Integration)

### 5.1 与现有系统的集成

**权限管理系统**
- 沿用现有 `isHost` 字段进行权限判断
- 复用 `src/views/LobbyView.vue` 中的房主检查逻辑
- 保持 `checkIsHost()` 函数的一致性

**Firebase 数据结构**
```
rooms/
├── {roomId}/
│   ├── hostId: string              // 现有：房主ID
│   ├── players: {}                 // 现有：玩家列表
│   ├── selectedGame: string        // 新增：选择的游戏
│   └── gameSettings: {}            // 新增：游戏配置参数
│       ├── gameType: string        // 游戏类型
│       ├── config: {}              // 具体参数
│       └── updatedAt: timestamp    // 更新时间
```

**组件复用策略**
- 复用 `HomeView.vue` 的对话框组件模式
- 复用 `LobbyView.vue` 的头像选择器样式
- 复用 `router/index.js` 的路由配置方式

### 5.2 新增文件结构
```
src/
├── views/
│   ├── LobbyView.vue               // 修改：增加游戏选择器
│   ├── GameSettingsView.vue        // 新增：游戏设置页面
│   └── components/
│       ├── GameSelector.vue        // 新增：游戏选择组件
│       └── GameConfig/
│           ├── PiZheConfig.vue     // 新增：屁者先知配置
│           └── index.vue           // 新增：配置容器
└── router/
    └── index.js                    // 修改：增加游戏设置路由
```

### 5.3 数据流设计

**读取流程**
```
用户进入大厅
    → 检查 isHost 权限
    → 从 Firebase 读取 selectedGame
    → 渲染游戏选择下拉菜单
    → 绑定选择事件
```

**写入流程**
```
用户更改选择
    → 触发 onChange 事件
    → 验证输入合法性
    → 更新 Firebase (rooms/{roomId}/selectedGame)
    → 其他客户端实时更新
```

### 5.4 错误处理机制

**权限错误**
- 检测到非管理员访问时，弹出提示并重定向
- 前端隐藏 + 后端校验双重保障

**网络错误**
- Firebase 操作失败时使用重试机制（参考现有 `retryOperation` 函数）
- 显示友好的错误提示信息

**数据错误**
- 参数校验失败时阻止保存
- 显示具体的错误原因

---

## 6. 用户体验设计 (UX Design)

### 6.1 界面布局原则

**大厅界面布局**
```
🏠 房间大厅
├── 房间信息（房间号、房主标识）
├── 玩家信息（昵称、头像、修改按钮）
├── 🎯 选择游戏 [新增]
│   └── 下拉菜单（屁者先知）
├── 邀请区域（二维码）
├── 玩家列表
├── 按钮组
│   ├── ⚙️ 游戏设置 [新增]  // 仅房主
│   └── 🎮 开始游戏          // 仅房主
└── 退出房间按钮
```

**游戏设置页面布局**
```
⚙️ 游戏设置 - 房间号：{roomId}
├── 返回大厅 [←]
├── 当前游戏：屁者先知
├── 参数配置表单
│   ├── 回合时间
│   ├── 胜利条件
│   ├── 特殊规则
│   └── ...
├── 按钮组
│   ├── 取消
│   └── 保存配置 [✓]
```

### 6.2 交互反馈设计

**游戏选择交互**
- 选择后立即显示成功状态（绿色勾选）
- 悬停时高亮显示
- 点击反馈有轻微缩放动画

**按钮交互**
- 房主按钮有特殊的视觉区分（金色边框）
- 点击时加载状态（显示「保存中...」）
- 成功后显示「✓ 已保存」状态

**表单交互**
- 实时验证参数合法性
- 错误提示使用红色，成功提示使用绿色
- 必填项用 * 标识

### 6.3 移动端适配

**响应式设计**
- 按钮大小适配小屏幕（最小 44px × 44px）
- 下拉菜单在移动端全屏显示
- 表单输入框高度增大（便于触摸）

**手势优化**
- 滑动返回（iOS 风格）
- 长按显示帮助提示

---

## 7. 扩展性考虑 (Scalability)

### 7.1 新游戏接入流程

**添加新游戏步骤**
1. 在游戏选择器中添加新选项
2. 创建对应的游戏配置组件（`GameConfig/NewGame.vue`）
3. 在主配置容器中注册组件
4. 定义游戏参数 schema
5. 在游戏中实现相应逻辑

**配置组件标准接口**
```javascript
// 游戏配置组件需实现的接口
export default {
  name: 'NewGameConfig',
  props: {
    config: Object,  // 当前配置
    onChange: Function  // 配置变更回调
  },
  data() {
    return {
      // 本地表单状态
    }
  },
  methods: {
    // 更新配置
    updateConfig(key, value) {
      this.onChange({ ...this.config, [key]: value })
    }
  }
}
```

### 7.2 数据库扩展

**游戏设置数据结构**
```javascript
// 屁者先知配置示例
{
  "gameType": "piZheXianZhi",
  "turnTimeLimit": 60,        // 回合时间限制（秒）
  "victoryScore": 150,         // 胜利得分
  "enablePenalty": true,       // 是否启用惩罚卡
  "playerCount": 4,            // 玩家数量
  "difficulty": "medium",      // 难度
  "updatedAt": 1702345678901,
  "updatedBy": "playerId"
}
```

**未来游戏配置示例**
```javascript
// 示例：新游戏「狼人杀」
{
  "gameType": "werewolf",
  "playerCount": 8,
  "roles": {
    "werewolf": 2,
    "seer": 1,
    "witch": 1,
    "villager": 4
  },
  "dayTimeLimit": 120,
  "nightTimeLimit": 60
}
```

### 7.3 版本兼容性

**向后兼容策略**
- 新增字段使用可选标识（`?`）
- 为旧数据提供默认值
- 数据库迁移脚本（如需要）

**向前兼容策略**
- 使用配置版本号（`configVersion`）
- 支持多版本配置格式解析
- 弃用字段标记为 deprecated

---

## 8. 测试计划 (Testing Plan)

### 8.1 单元测试

**组件测试**
- `GameSelector.vue` 组件测试
  - 默认值测试
  - 选择事件触发测试
  - 数据绑定测试

- `GameSettingsView.vue` 组件测试
  - 路由参数解析测试
  - 配置读取测试
  - 配置保存测试

**逻辑测试**
- 权限判断逻辑测试
- 参数校验函数测试
- 数据转换函数测试

### 8.2 集成测试

**权限测试**
- 房主能访问所有功能
- 普通玩家无法访问管理功能
- 权限变更后功能实时响应

**数据流测试**
- 选择游戏后数据正确保存
- 配置变更实时同步到所有客户端
- 网络错误时数据不丢失

**路由测试**
- 新路由正确注册
- URL 参数正确解析
- 重定向机制正常

### 8.3 用户验收测试

**场景 1：房主配置游戏**
1. 房主进入大厅
2. 看到游戏选择器（默认选择屁者先知）
3. 点击游戏设置按钮
4. 进入设置页面配置参数
5. 保存并返回大厅
6. 其他玩家看到配置结果

**场景 2：普通玩家加入**
1. 普通玩家进入大厅
2. 看到游戏选择结果
3. 看不到游戏设置按钮
4. 尝试直接访问设置页面被重定向

### 8.4 性能测试

- 大厅界面加载时间 < 2s
- 游戏设置保存延迟 < 500ms
- 配置同步延迟 < 1s
- 支持同时 100+ 玩家在线

---

## 9. 发布计划 (Release Plan)

### 9.1 开发阶段

**Phase 1：基础架构 (1-2天)**
- [ ] 新增游戏设置页面路由
- [ ] 创建 GameSettingsView.vue 基础框架
- [ ] 实现权限控制逻辑

**Phase 2：游戏选择功能 (1天)**
- [ ] 在 LobbyView.vue 添加游戏选择器
- [ ] 实现选择事件和数据绑定
- [ ] 集成 Firebase 数据存储

**Phase 3：游戏设置页面 (2-3天)**
- [ ] 创建游戏配置组件架构
- [ ] 实现屁者先知配置界面
- [ ] 添加参数校验和保存功能

**Phase 4：测试和优化 (1天)**
- [ ] 完整功能测试
- [ ] 移动端适配优化
- [ ] 性能优化
- [ ] Bug 修复

### 9.2 部署计划

**环境准备**
- 开发环境测试
- Firebase 配置检查
- 路由配置验证

**发布流程**
1. 代码审查（Code Review）
2. 合并到主分支
3. 部署到生产环境
4. 功能验证测试
5. 用户通知和文档更新

### 9.3 风险评估

**技术风险**
- Firebase 权限配置问题
- 路由冲突风险
- 现有功能回归测试

**缓解措施**
- 提前在开发环境完整测试
- 保留回滚方案
- 分步发布降低风险

---

## 10. 附录 (Appendix)

### 10.1 相关文档链接
- 现有系统架构文档
- Firebase 使用指南
- Vue Router 配置文档

### 10.2 参考资源
- Vue 3 官方文档
- Firebase Realtime Database 文档
- Material Design 交互规范

### 10.3 术语表

| 术语 | 定义 |
|------|------|
| 房主 (Host) | 创建房间的玩家，具有管理权限 |
| 权限控制 | 基于用户身份的功能访问控制机制 |
| 游戏配置 | 游戏的规则和参数设置 |
| 实时同步 | 多客户端数据的即时更新机制 |
| Schema | 数据结构的定义规范 |

---

**文档状态：** ✅ 已完成
**下次更新：** 根据开发进展更新

---

> 📝 **注意**：本 PRD 为游戏设置功能的初始版本，后续可根据开发进展和用户反馈进行调整和优化。
